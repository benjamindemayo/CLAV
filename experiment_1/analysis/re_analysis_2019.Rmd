---
title: "CLAV Data Analysis"
author: "Benny deMayo"
date: "June 5, 2015"
output:
  html_document:
    highlight: pygments
    theme: flatly
  pdf_document: default
---

### Intro and Imports
I first clear all previous variables and load libraries for data manipulation and graphing
```{r message=FALSE, warning=FALSE}
rm(list = ls())

library(tidyverse)
library(lmerTest)
library(fs)
library(lubridate)


#file paths
project_root <- here::here()
files <- dir_ls(path(project_root, "experiment_1", "full_dataset"))
demographics <- path(project_root, "clav_demographics.csv")
```


We then load in data from all of the individual data files. 
```{r message=FALSE, warning=FALSE}

#here, we create a data frame with all of the trial level data
d <- 
  files %>% 
  map_df(~read_csv(.)) %>% #read all of the CSV's into one data frame
  select(-`X16`) #get rid of this weird column that occurs in a couple of the csv's

full_participant_n <- length(unique(d$subjectID))

```

We see that there are `r full_participant_n` individual data files, although as we will see later, we are unable to recover demographic information for all of these participants.

#### Merge in demographic data

Next, we merge in demographic data.
```{r message=FALSE, warning=FALSE}
#read in demographics even though they are incomplete
demos <- 
  read_csv(demographics)

df <- 
  d %>% 
  mutate(
    is.correct = clicked == correct, 
    #add a correct column as a logical of whether 'clicked' matched 'correct'
  ) %>% 
  left_join(demos, by = "subjectID") %>% 
  mutate(
    subjectID = factor(subjectID),
  ) %>% 
  filter(!is.na(age)) %>% 
  mutate(
    age = lubridate::interval(mdy(BirthDate), mdy(TestDate))/lubridate::years(1),
    age_years = factor(floor(age))
  )


demo_participant_n <- length(unique(df$subjectID))
mean_age <- mean(df$age) %>% round(2)

```

Once we merge in the demographic information, we see that we only have full data for `r demo_participant_n` participants, meaning that we are unable to recover demographic information for `r full_participant_n - demo_participant_n` participants. Mean age of the sample is `r mean_age`. Number of participants by age and gender is shown below.

```{r}
by_age <- 
  df %>%
  group_by(subjectID) %>% 
  slice(1) %>% 
  ungroup() %>% 
  count(age_years, gender)

knitr::kable(by_age)

```


#### Repeated trials in some subjects

Since we notice some oddities in the data, we first look at which condition and how many trials each participant experienced.
```{r message=FALSE, warning=FALSE}
#count the number of subjects and their counterbalance conditions
subs <- 
  df %>% 
  group_by(subjectID, list_number) %>%
  count

subs
```
We find that there is some bug (?) such that occasionally identical trials are repeated. These should likely be dropped. 

### Descriptives

Next, we get a sense of the distribution of the data.
```{r message=FALSE, warning=FALSE}

summary(df)

m.rt <- exp(mean(log(df$RT), na.rm = TRUE)) 

#take log average of RT: average natural logs of RTs, then take the exponential of that

#from benny - why is he doing this log thing?

sd.rt <- exp(sd(log(df$RT),na.rm = TRUE)) #geometric standard deviation: exponentiated value of the standard deviation of the log-transformed values

qplot(RT, data = df) + 
  geom_vline(xintercept = m.rt + 2*sd.rt, col = "red", lty = 2) + #lets us view how much is spread 2 SDs above mean
  geom_vline(xintercept = m.rt - 2*sd.rt, col = "red", lty = 2) + #lets us view how much is spread 2 SDs below mean
  xlab("RT spread") +
  ylab("Frequency") +
  ggtitle("RT Histogram of CLAV Data (marking +/- 2 SDs)")
```


Here, we trim off trials with very short or long reaction times, center age and add a column for log RT.
```{r message=FALSE, warning=FALSE}

df <- 
  df %>% 
  filter(RT > m.rt - (2 * sd.rt) & RT < m.rt + (2 * sd.rt)) %>% #take out kids with weird RT's
  mutate(age_c = age - mean(df$age), log_rt = log(RT))

```


#### Analysis: Aggregating Mean RTs and Proportion Correct

Various visualizations of the data.

```{r message=FALSE, warning=FALSE}

summary_age_continuous <- 
  df %>% 
  group_by(subjectID, has_comp, age) %>% 
  summarise(prop_correct = mean(is.correct, na.rm = TRUE)) %>% 
  ungroup()

summary_age_continuous %>% 
  ggplot(aes(age, prop_correct, color = has_comp)) +
  geom_point() +
  geom_smooth(method = "loess") +
  coord_cartesian(xlim = c(3, 5)) +
  theme_minimal() +
  labs(
    title = "Task accuracy by age and trial type",
    subtitle = "Each point represents one child in one condition",
    y = "proportion correct"
  )


summary_df <- 
  df %>% 
  group_by(subjectID, age_years, has_comp) %>% 
  summarize(prop_correct = mean(is.correct, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(age_years, has_comp) %>% 
  langcog::multi_boot_standard(col = "prop_correct")

 
summary_df %>% 
  ggplot(aes(age_years, fill = has_comp)) +
  geom_col(aes(y = mean), position = "dodge", width = 1) +
  geom_errorbar(
    aes(ymin = ci_lower, ymax = ci_upper),
    size = 0.3,
    width = 0.2,
    position = position_dodge(1)
  ) + #is there a better way to deal with this? 
  labs(
    y = "accuracy",
    title = "Accuracy by age and trial type",
    subtitle = "All children succeed in non-competitor trials;\n4- and 5-year-olds are more accurate than 3-year-olds on competitor trials"
  )




```

Both plots clearly demonstrate that children are performing much better on the non-competitor trials than on the competitor trials, which is expected. We also see an effect of age, such that overall task performance improves as children develop.

Now we plot RT by trial type and age.

```{r message=FALSE, warning=FALSE}

summary_rt_df <- 
  df %>% 
  group_by(age_years, subjectID, has_comp) %>% 
  summarize(mean_rt = mean(RT, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(has_comp, age_years) %>% 
  langcog::multi_boot_standard(col = "mean_rt")

summary_rt_df %>% 
  ggplot(aes(x = age_years, y = mean, fill = has_comp)) +
  geom_col(position = "dodge", width = 1) +
  geom_errorbar(
    aes(ymin = ci_lower, ymax = ci_upper),
    size = 0.3,
    width = 0.2,
    position = position_dodge(1)
  ) +
  labs(
    title = "Reaction time by age and trial type",
    subtitle = "3-year-olds are slower to disambiguate using spoken speech than 4's and 5's",
    y = "reaction time (secs)"
  )

rt_age_continuous <- 
  df %>% 
  group_by(subjectID, has_comp, age) %>% 
  summarize(mean_rt = mean(RT, na.rm = TRUE)) %>% 
  ungroup()

rt_age_continuous %>% 
  ggplot(aes(age, mean_rt, color = has_comp)) +
  geom_point() +
  geom_smooth(method = "loess") +
  coord_cartesian(xlim = c(3, 5)) +
  theme_minimal() +
  labs(
    title = "Reaction time by age and trial type",
    subtitle = "Each point represents one child in one condition",
    y = "mean reaction time (secs)"
  )



```

Both plots show that younger children are slower than older children in general, although there does not appear to be a strong trend such that children improve more in the competitor (difficult) trials than those without a competitor stimulus.


Inferential statistics:

```{r}
model <- glmer(is.correct ~ age_c * has_comp + (has_comp | subjectID) + (1 | tar_name), data = df, family = "binomial")

summary(model)
```

The model fails to converge with age as a categorical variable. As a continuous variable, the model shows significant main effects of trial type and age on accuracy. We do not see an interaction between age and trial type.

```{r}
rt_model <- 
  lmer(log_rt ~ age_c * has_comp + (has_comp | subjectID) + (1 | tar_name), data = df)

summary(rt_model)
```

When we fit a linear mixed-effects model to the data to predict log RT, we see no effect of age or trial type on reaction time. 